<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flexibel revers – interaktiv kalkyl (Fastighetsbyrån)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --orange:#ff5f00; --bark:#512b2b; --apricot:#fdf6ee; --thistle:#fbf3f7;
      --white:#ffffff; --turquoise:#31a3ae; --teal:#257886;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--bark);background:var(--apricot)}
    .topbar{display:flex;align-items:center;gap:14px;padding:14px 18px;background:var(--white);border-bottom:1px solid #eee;position:sticky;top:0;z-index:10}
    .brand img{height:38px;width:auto}
    .title{font-weight:700;font-size:18px}
    .wrap{max-width:1400px;margin:20px auto;padding:0 24px;display:grid;grid-template-columns:minmax(320px,360px) minmax(0,1fr);gap:20px}
    .card{background:var(--white);border:1px solid #eee;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .pad{padding:16px} h1{font-size:20px;margin:0 0 12px;color:var(--bark)}
    .row{margin-bottom:12px} label{display:block;font-size:12px;color:#6b4c4c;margin-bottom:6px}
    input[type=number]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e6d9d3;background:#fff;color:var(--bark)}
    input[disabled]{background:#f7f2ef;color:#9b7e7e}
    .slider{display:flex;align-items:center;gap:8px} input[type=range]{width:100%}
    .slider-value{font-weight:700;font-size:13px;min-width:42px;text-align:right}
    .financing-box{border:1px solid #f2e3da;background:#fff7f0;border-radius:12px;padding:12px;margin-bottom:12px}
    .financing-row{margin-bottom:12px}
    .financing-head{display:flex;justify-content:space-between;font-size:12px;color:#6b4c4c;margin-bottom:4px}
    .financing-head strong{color:var(--bark);font-size:14px}
    .warning{background:#fff1f0;color:#c0392b;border:1px solid #f5c2c0;border-radius:10px;padding:8px 10px;font-size:12px;margin-top:6px}
    .pill{background:var(--thistle);padding:10px 12px;border-radius:12px;font-size:13px;border:1px solid #f0e6ee}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .muted{color:#7d5f5f} .switch{display:flex;gap:8px;align-items:center}
    .tablewrap{overflow:auto;border-radius:12px;border:1px solid #eee;background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;font-size:12px;text-align:right}
    th{text-align:left;background:#faf7f4;color:#5b3e3e;position:sticky;top:0}
    tr:nth-child(even){background:#fff7f0}
    .tag{font-size:11px;color:#8e6f6f}
    .btn{cursor:pointer;padding:8px 10px;border-radius:10px;border:1px solid #e6d9d3;background:#fff;color:#5a2d15}
    .accent{color:var(--orange)} .hint{font-size:12px;color:#6b4c4c;margin-top:8px}
    .chartbox{height:360px;position:relative;background:#fff7f0;border:1px solid #f2e3da;border-radius:12px;padding:10px}
    @media (max-width:980px){ .wrap{grid-template-columns:1fr} }
    .login-wrap{display:flex;align-items:center;justify-content:center;min-height:calc(100vh - 80px);padding:16px}
    .login-card{max-width:360px;width:100%}
    .login-card h1{margin-top:0;margin-bottom:12px}
    .login-card .row{margin-bottom:14px}
    .session-controls{margin-left:auto;display:none;align-items:center;gap:10px}
    .session-controls.active{display:flex}
    .error{color:#c0392b;font-size:12px;margin-top:8px}
    .fader{opacity:0;transition:opacity .35s ease}
    .fader.shown{opacity:1}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <!-- Byt LOGO_URL_HERE till publik URL för Fastighetsbyråns logotyp -->
      <img src="img/Fastighetsbyran_rgb_svart.png" alt="Fastighetsbyrån"/>
    </div>
    <div class="title">Flexibel revers – interaktiv kalkyl (Fastighetsbyrån)</div>
    <div class="session-controls" id="sessionControls">
      <span class="pill hidden" id="activeProfile"></span>
      <button class="btn" type="button" id="logoutBtn">Logga ut</button>
    </div>
  </div>

  <div id="loginScreen" class="login-wrap fader shown">
    <div class="card pad login-card">
      <h1>Logga in</h1>
      <p class="muted" style="margin-top:0">Ange ditt lösenord för att komma åt kalkylatorn.</p>
      <form id="loginForm">
        <div class="row">
          <label for="loginPassword">Lösenord</label>
          <input type="password" id="loginPassword" autocomplete="current-password" required />
        </div>
        <button type="submit" class="btn" style="width:100%">Logga in</button>
        <div id="loginError" class="error hidden">Fel lösenord, försök igen.</div>
      </form>
    </div>
  </div>

  <div class="wrap hidden fader" id="calculatorWrap">
    <div class="card pad">
      <h1>Antaganden</h1>

      <div class="row">
        <label>Bolagsvärde (kr)</label>
        <input type="number" id="companyValue" value="8000000" />
      </div>

      <div class="row">
        <label>Lån (kr)</label>
        <input type="number" id="companyDebt" value="500000" />
        <div class="tag" id="equityTag">Eget kapital: 7 500 000 kr</div>
      </div>


      <div class="row">
        <label>Omsättning: <span id="turnoverLbl" class="accent">13 453 000 kr</span></label>
        <input type="number" id="turnover" value="13453000" />
      </div>

      <div class="row">
        <label>Vinstmarginal: <span id="marginLbl" class="accent">19,4%</span></label>
        <div class="slider"><input type="range" id="margin" min="0" max="100" step="0.1" value="19.4"/></div>
      </div>

      <div class="row">
        <label>Bolagets resultat före skatt: <span id="resultBeforeTaxLbl" class="accent">—</span></label>
      </div>

      <div class="row">
        <label>Bolagsskatt: <span id="taxLbl" class="accent">20,6%</span></label>
        <div class="slider"><input type="range" id="corpTax" min="10" max="30" step="0.1" value="20.6" disabled/></div>
      </div>

      <div class="row">
        <label>Bolagets resultat efter skatt: <span id="resultAfterTaxLbl" class="accent">—</span></label>
      </div>

      <div class="row">
        <label>Ägarandel: <span id="ownershipLbl" class="accent">16%</span></label>
        <div class="slider"><input type="range" id="ownership" min="1" max="100" step="1" value="16"/></div>
      </div>

      <div class="row">
        <label>Köpeskilling (kr)</label>
        <input type="number" id="note" value="1200000" />
        <div class="tag" id="purchasePriceTag">Köpeskilling: 1 200 000 kr</div>
      </div>

      <div class="row switch">
        <input type="checkbox" id="calcNoteFromEquity" checked />
        <label for="calcNoteFromEquity" style="margin:0">Beräkna köpeskilling från eget kapital (andel × eget kapital)</label>
      </div>

      <div class="row">
        <label>Fördelning av köpeskillingen <span id="fundingSumLbl" class="accent">100%</span></label>
      </div>
      <div class="financing-box">
        <div class="financing-row">
          <div class="financing-head"><strong>Revers</strong><span id="reversAmountLbl">—</span></div>
          <div class="slider"><input type="range" id="reversShare" min="0" max="100" step="1" value="60"/><span class="slider-value" id="reversShareLbl">60%</span></div>
        </div>
        <div class="financing-row">
          <div class="financing-head"><strong>Banklån</strong><span id="bankAmountLbl">—</span></div>
          <div class="slider"><input type="range" id="bankShare" min="0" max="100" step="1" value="30"/><span class="slider-value" id="bankShareLbl">30%</span></div>
        </div>
        <div class="financing-row" style="margin-bottom:0">
          <div class="financing-head"><strong>Eget kapital</strong><span id="equityAmountLbl">—</span></div>
          <div class="slider"><input type="range" id="equityShare" min="0" max="100" step="1" value="10"/><span class="slider-value" id="equityShareLbl">10%</span></div>
        </div>
      </div>

      <div class="row">
        <label>Andel av utdelning som amorteras: <span id="amortShareLbl" class="accent">50%</span></label>
        <div class="slider"><input type="range" id="amortShare" min="0" max="100" step="1" value="50"/></div>
      </div>

      <div class="row">
        <label>Ränta på revers: <span id="rateLbl" class="accent">2,0%</span></label>
        <div class="slider"><input type="range" id="rate" min="0" max="15" step="0.1" value="2"/></div>
      </div>

      <div class="row">
        <label>Ränta banklån: <span id="bankRateLbl" class="accent">5,0%</span></label>
        <div class="slider"><input type="range" id="bankRate" min="0" max="10" step="0.1" value="5"/></div>
      </div>

      <div class="row">
        <label>Amorteringstid banklån: <span id="bankYearsLbl" class="accent">5 år</span></label>
        <div class="slider"><input type="range" id="bankYears" min="0" max="10" step="1" value="5"/></div>
      </div>

      <div class="row switch">
        <input type="checkbox" id="interestOnly" checked />
        <label for="interestOnly" style="margin:0">Första året amorteringsfritt</label>
      </div>

      <div class="row">
        <label>Max antal år att simulera: <span id="yearsLbl" class="accent">15</span></label>
        <div class="slider"><input type="range" id="maxYears" min="1" max="30" step="1" value="15"/></div>
      </div>

      <div class="row"><button class="btn" id="reset">Återställ</button></div>

      <p class="hint">
        Antar att vald andel av delägarens bruttoutdelning går till amortering av reversen.
        Ränta dras från kassautdelningen. År 1 kan göras amorteringsfritt.
      </p>

      <div class="row switch" style="margin-top:8px">
        <input type="checkbox" id="lockCompanyFields" checked />
        <label for="lockCompanyFields" style="margin:0">Lås bolagsvärde och lån</label>
      </div>
    </div>

    <div class="card pad">
      <div style="font-weight:700; font-size:18px; margin-bottom:10px">Summering</div>
      <div class="grid" style="margin-bottom:12px">
        <div class="pill"><div class="muted">Delägarens utdelning/år</div><div id="divPerYear" style="font-size:18px;font-weight:700">—</div></div>
        <div class="pill"><div class="muted">År 1 – amortering revers</div><div id="y1Amort" style="font-size:18px;font-weight:700">—</div></div>
        <div class="pill"><div class="muted">År 1 – amortering bank</div><div id="y1BankAmort" style="font-size:18px;font-weight:700">—</div></div>
        <div class="pill"><div class="muted">År 1 – kassautdelning</div><div id="y1Cash" style="font-size:18px;font-weight:700">—</div></div>
      </div>
      <div class="grid" style="margin-bottom:12px">
        <div class="pill"><div class="muted">År till helt återbetald revers</div><div id="reversYearsToZero" style="font-size:18px;font-weight:700">—</div></div>
        <div class="pill"><div class="muted">År till helt återbetalt banklån</div><div id="bankYearsToZero" style="font-size:18px;font-weight:700">—</div></div>
        <div class="pill"><div class="muted">Reversbelopp</div><div id="reversAmountSummary" style="font-size:18px;font-weight:700">—</div></div>
        <div class="pill"><div class="muted">Banklånebelopp</div><div id="bankAmountSummary" style="font-size:18px;font-weight:700">—</div></div>
      </div>
      <div class="grid" style="margin-bottom:12px">
        <div class="pill"><div class="muted">Eget kapital (insats)</div><div id="equityAmountSummary" style="font-size:18px;font-weight:700">—</div></div>
        <div class="pill"><div class="muted">Köpeskilling</div><div id="purchasePriceSummary" style="font-size:18px;font-weight:700">—</div></div>
        <div class="pill"><div class="muted">Årlig bankbetalning</div><div id="bankPaymentSummary" style="font-size:18px;font-weight:700">—</div></div>
        <div class="pill"><div class="muted">Delägarens andel av resultat (före skatt)</div><div id="ownerSharePBT" style="font-size:18px;font-weight:700">—</div></div>
      </div>

      <div class="chartbox"><canvas id="chart"></canvas></div>

      <div style="font-weight:700; font-size:18px; margin-top:14px">Tabell (till och med första året med endast kassautdelning)</div>
      <div class="tablewrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>År</th>
              <th>Utdelning</th>
              <th>Amortering revers</th>
              <th>Amortering bank</th>
              <th>Ränta revers</th>
              <th>Ränta bank</th>
              <th>Kassautd.</th>
              <th>Kvar revers</th>
              <th>Kvar bank</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Hjälpfunktion för kronor
    const fmtKr = (n) => (Math.round(n)).toLocaleString('sv-SE') + ' kr';

    function calcAnnuityPayment(principal, rate, years) {
      if (principal <= 0 || years <= 0) return 0;
      if (rate <= 0) return principal / years;
      const factor = rate / (1 - Math.pow(1 + rate, -years));
      return principal * factor;
    }

    // Beräkning
    function simulate(opts) {
      const years = [];
      let reversRemaining = opts.reversPrincipal;
      let bankRemaining   = opts.bankPrincipal;
      let y = 0;
      const profitAfterTax = opts.profitBeforeTax * (1 - opts.corpTaxRate);
      const ownerDividend  = profitAfterTax * opts.ownership;
      const bankPayment    = (opts.bankAmortYears > 0)
        ? calcAnnuityPayment(opts.bankPrincipal, opts.bankInterestRate, opts.bankAmortYears)
        : 0;

      while (y < opts.maxYears && (reversRemaining > 1 || bankRemaining > 1)) {
        y++;
        const reversInterest = reversRemaining > 1 ? reversRemaining * opts.reversRate : 0;
        const canAmortize    = (opts.firstYearInterestOnly && y === 1) ? 0 : ownerDividend * opts.amortShare;
        const reversPrincipalPayment = Math.min(canAmortize, reversRemaining);
        reversRemaining = Math.max(0, reversRemaining - reversPrincipalPayment);

        let bankInterest = bankRemaining > 1 ? bankRemaining * opts.bankInterestRate : 0;
        let bankPrincipalPayment = 0;
        if (bankRemaining > 1) {
          if (opts.bankAmortYears <= 0) {
            bankPrincipalPayment = 0;
          } else if (bankPayment > 0) {
            bankPrincipalPayment = Math.min(Math.max(bankPayment - bankInterest, 0), bankRemaining);
          } else if (opts.bankAmortYears > 0) {
            const yearsLeft = Math.max(opts.bankAmortYears - (y - 1), 1);
            bankPrincipalPayment = Math.min(bankRemaining, bankRemaining / yearsLeft);
          }
          bankRemaining = Math.max(0, bankRemaining - bankPrincipalPayment);
        } else {
          bankInterest = 0;
        }

        const cashPayout = Math.max(0, ownerDividend - reversPrincipalPayment - reversInterest - bankPrincipalPayment - bankInterest);
        years.push({
          year:y,
          ownerDividend,
          reversPrincipalPayment,
          bankPrincipalPayment,
          reversInterest,
          bankInterest,
          cashPayout,
          reversRemaining,
          bankRemaining
        });
      }
      if (reversRemaining <= 1 && bankRemaining <= 1) {
        const nextYear = years.length ? years[years.length-1].year + 1 : 1;
        years.push({
          year: nextYear,
          ownerDividend,
          reversPrincipalPayment:0,
          bankPrincipalPayment:0,
          reversInterest:0,
          bankInterest:0,
          cashPayout: Math.max(0, ownerDividend),
          reversRemaining:0,
          bankRemaining:0
        });
      }
      return { years, bankPayment };
    }

    // Element
    const $ = (id) => document.getElementById(id);
    const loginScreen = $('loginScreen');
    const calculatorWrap = $('calculatorWrap');
    const loginForm = $('loginForm');
    const loginPassword = $('loginPassword');
    const loginError = $('loginError');
    const sessionControls = $('sessionControls');
    const activeProfile = $('activeProfile');
    const logoutBtn = $('logoutBtn');

    const PROFILE_STORAGE_KEY = 'flexibelReversSession';
    // Observera: hashade lösenord nedan motsvarar Möller, Board2024! respektive Growth55
    const profileConfigs = {
      'eb78163e7d1c1aa49f4c6c3fe830550d7467f08eb28b735ac813b0041c8f7ecc': {
        label:'Joackim',
        companyValue:8000000,
        companyDebt:500000,
        turnover:13453000,
        margin:19.4,
        corpTax:20.6,
        ownership:16,
        calcNoteFromEquity:true,
        amortShare:50,
        rate:2,
        interestOnly:true,
        maxYears:15,
        lockCompanyFields:true
      },
      '6d3e84209b4b7369a11152676031f24f88a4a6612688700b854bb20d9a4c5f4a': {
        label:'Styrelse',
        companyValue:14000000,
        companyDebt:3000000,
        turnover:21500000,
        margin:17.5,
        corpTax:20.6,
        ownership:25,
        calcNoteFromEquity:false,
        note:1800000,
        amortShare:60,
        rate:2.8,
        interestOnly:false,
        maxYears:12,
        lockCompanyFields:false
      },
      'fe5c6340cfc5d49e57e0a127780ad3ba202815c4606974c2c77dc25561bf33cc': {
        label:'Tillväxt-case',
        companyValue:9500000,
        companyDebt:1200000,
        turnover:16200000,
        margin:22.0,
        corpTax:20.6,
        ownership:35,
        calcNoteFromEquity:true,
        amortShare:55,
        rate:3.2,
        interestOnly:true,
        maxYears:10,
        lockCompanyFields:false
      }
    };
    let activeProfileHash = null;

    function showWithFade(el) {
      if (!el || !el.classList.contains('fader')) {
        return;
      }
      el.classList.remove('hidden');
      requestAnimationFrame(() => {
        el.classList.add('shown');
      });
    }

    function hideWithFade(el) {
      if (!el || !el.classList.contains('fader') || el.classList.contains('hidden')) {
        return;
      }
      el.classList.remove('shown');
      el.addEventListener('transitionend', () => {
        el.classList.add('hidden');
      }, { once:true });
    }

    async function hashPassword(password) {
      if (!window.crypto || !window.crypto.subtle) {
        throw new Error('Web Crypto API saknas');
      }
      const utf8 = new TextEncoder().encode(password);
      const hashBuffer = await window.crypto.subtle.digest('SHA-256', utf8);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    const companyValue = $('companyValue');
    const companyDebt  = $('companyDebt');
    const equityTag    = $('equityTag');
    const ownership    = $('ownership');
    const ownershipLbl = $('ownershipLbl');
    const turnover    = $('turnover');
    const turnoverLbl = $('turnoverLbl');
    const margin      = $('margin');
    const marginLbl   = $('marginLbl');
    const corpTax      = $('corpTax');
    const taxLbl       = $('taxLbl');
    const note         = $('note');
    const purchasePriceTag = $('purchasePriceTag');
    const amortShare   = $('amortShare');
    const amortShareLbl= $('amortShareLbl');
    const rate         = $('rate');
    const rateLbl      = $('rateLbl');
    const bankRateInput= $('bankRate');
    const bankYearsInput=$('bankYears');
    const bankRateLbl = $('bankRateLbl');
    const bankYearsLbl = $('bankYearsLbl');
    const interestOnly = $('interestOnly');
    const maxYears     = $('maxYears');
    const yearsLbl     = $('yearsLbl');
    const reversShare  = $('reversShare');
    const bankShare    = $('bankShare');
    const equityShare  = $('equityShare');
    const reversShareLbl = $('reversShareLbl');
    const bankShareLbl   = $('bankShareLbl');
    const equityShareLbl = $('equityShareLbl');
    const reversAmountLbl = $('reversAmountLbl');
    const bankAmountLbl   = $('bankAmountLbl');
    const equityAmountLbl = $('equityAmountLbl');
    const fundingSumLbl   = $('fundingSumLbl');
    const divPerYear   = $('divPerYear');
    const y1Amort      = $('y1Amort');
    const y1BankAmort  = $('y1BankAmort');
    const y1Cash       = $('y1Cash');
    const reversYearsToZero  = $('reversYearsToZero');
    const bankYearsToZero    = $('bankYearsToZero');
    const ownerSharePBT = $('ownerSharePBT');
    const resultAfterTaxLbl = $('resultAfterTaxLbl');
    const resultBeforeTaxLbl = $('resultBeforeTaxLbl');
    const reversAmountSummary = $('reversAmountSummary');
    const bankAmountSummary   = $('bankAmountSummary');
    const equityAmountSummary = $('equityAmountSummary');
    const purchasePriceSummary= $('purchasePriceSummary');
    const bankPaymentSummary  = $('bankPaymentSummary');
    const reset        = $('reset');
    const calcNoteFromEquity = $('calcNoteFromEquity');
    const lockCompanyFields  = $('lockCompanyFields');

    const shareInputs = {
      revers: reversShare,
      bank: bankShare,
      equity: equityShare
    };
    const shareAdjustOrder = {
      revers: ['bank','equity'],
      bank: ['revers','equity'],
      equity: ['bank','revers']
    };

    const clampShare = (value) => Math.min(100, Math.max(0, Math.round(value)));
    const shareTotal = () => Number(reversShare.value||0) + Number(bankShare.value||0) + Number(equityShare.value||0);

    function setShareValue(key, value) {
      const input = shareInputs[key];
      if (!input) return;
      input.value = clampShare(value);
    }

    function rebalanceShares(activeKey, desiredValue) {
      setShareValue(activeKey, desiredValue);
      const order = shareAdjustOrder[activeKey] || [];
      let total = shareTotal();
      if (total === 100) return;
      if (total > 100) {
        let excess = total - 100;
        for (const key of order) {
          if (excess <= 0) break;
          const current = Number(shareInputs[key].value||0);
          const reduction = Math.min(current, excess);
          setShareValue(key, current - reduction);
          excess -= reduction;
        }
        if (excess > 0) {
          const current = Number(shareInputs[activeKey].value||0);
          setShareValue(activeKey, current - excess);
        }
      } else {
        let deficit = 100 - total;
        for (const key of order) {
          if (deficit <= 0) break;
          const current = Number(shareInputs[key].value||0);
          const space = 100 - current;
          const increase = Math.min(space, deficit);
          setShareValue(key, current + increase);
          deficit -= increase;
        }
        if (deficit > 0) {
          const current = Number(shareInputs[activeKey].value||0);
          setShareValue(activeKey, current + deficit);
        }
      }
    }

    function bindShareHandlers() {
      Object.keys(shareInputs).forEach(key => {
        const handler = (event) => {
          rebalanceShares(key, Number(event.target.value||0));
          update();
        };
        shareInputs[key].addEventListener('input', handler);
        shareInputs[key].addEventListener('change', handler);
      });
    }

    function applyProfile(profile) {
      if (!profile) return;

      if (profile.calcNoteFromEquity !== undefined) {
        calcNoteFromEquity.checked = profile.calcNoteFromEquity;
      }
      if (profile.lockCompanyFields !== undefined) {
        lockCompanyFields.checked = profile.lockCompanyFields;
      }
      if (profile.companyValue !== undefined) {
        companyValue.value = profile.companyValue;
      }
      if (profile.companyDebt !== undefined) {
        companyDebt.value = profile.companyDebt;
      }
      if (profile.turnover !== undefined) {
        turnover.value = profile.turnover;
      }
      if (profile.margin !== undefined) {
        margin.value = profile.margin;
      }
      if (profile.corpTax !== undefined) {
        corpTax.value = profile.corpTax;
      }
      if (profile.ownership !== undefined) {
        ownership.value = profile.ownership;
      }
      if (profile.note !== undefined) {
        note.value = profile.note;
      }
      if (profile.amortShare !== undefined) {
        amortShare.value = profile.amortShare;
      }
      if (profile.rate !== undefined) {
        rate.value = profile.rate;
      }
      if (profile.interestOnly !== undefined) {
        interestOnly.checked = profile.interestOnly;
      }
      if (profile.maxYears !== undefined) {
        maxYears.value = profile.maxYears;
      }

      update();
    }

    function showCalculator(profileHash) {
      const profile = profileConfigs[profileHash];
      if (!profile) {
        return;
      }
      activeProfileHash = profileHash;
      applyProfile(profile);
      localStorage.setItem(PROFILE_STORAGE_KEY, profileHash);
      if (loginForm) {
        loginForm.reset();
      }
      if (loginError) {
        loginError.textContent = 'Fel lösenord, försök igen.';
        loginError.classList.add('hidden');
      }
      hideWithFade(loginScreen);
      showWithFade(calculatorWrap);
      if (sessionControls) {
        sessionControls.classList.add('active');
      }
      if (activeProfile) {
        activeProfile.textContent = profile.label || 'Aktiv profil';
        activeProfile.classList.remove('hidden');
      }
    }

    function showLogin(clearSession = false) {
      if (clearSession) {
        localStorage.removeItem(PROFILE_STORAGE_KEY);
        activeProfileHash = null;
      }
      hideWithFade(calculatorWrap);
      showWithFade(loginScreen);
      if (sessionControls) {
        sessionControls.classList.remove('active');
      }
      if (activeProfile) {
        activeProfile.textContent = '';
        activeProfile.classList.add('hidden');
      }
      if (loginError) {
        loginError.textContent = 'Fel lösenord, försök igen.';
        loginError.classList.add('hidden');
      }
      if (loginForm) {
        loginForm.reset();
      }
      if (loginPassword) {
        setTimeout(() => loginPassword.focus(), 300);
      }
    }

    // Graf
    let chart;
    function buildChart(series) {
      const ctx = document.getElementById('chart');
      const datasets = [
        { label:'Amortering revers', data: series.reversAmort, stack:'cashflow', backgroundColor:'#31a3ae' },
        { label:'Amortering bank', data: series.bankAmort, stack:'cashflow', backgroundColor:'#6bbbbb' },
        { label:'Ränta revers', data: series.reversInterest, stack:'cashflow', backgroundColor:'#257886' },
        { label:'Ränta bank', data: series.bankInterest, stack:'cashflow', backgroundColor:'#4f8a98' },
        { label:'Kassautdelning', data: series.cash, stack:'cashflow', backgroundColor:'#ff5f00' },
        { label:'Total utdelning', type:'line', data: series.totalDividend, borderColor:'#512b2b', pointRadius:2, borderWidth:2, tension:.15, yAxisID:'y' },
        { label:'Kvarvarande skuld revers', type:'line', data: series.reversRemaining, borderColor:'#bc6c25', pointRadius:2, borderWidth:2, borderDash:[4,4], yAxisID:'y1' },
        { label:'Kvarvarande skuld bank', type:'line', data: series.bankRemaining, borderColor:'#512b2b', pointRadius:2, borderWidth:2, borderDash:[2,3], yAxisID:'y1' }
      ];
      if (!chart) {
        chart = new Chart(ctx, {
          type: 'bar',
          data: { labels: series.labels, datasets },
          options: {
            responsive:true, maintainAspectRatio:false,
            scales:{ y:{ stacked:true, title:{ display:true, text:'Belopp (kr)' } },
                    y1:{ position:'right', grid:{ drawOnChartArea:false }, title:{ display:true, text:'Kvarvarande skuld (kr)' } } },
            plugins:{ legend:{ labels:{ boxWidth:12 } },
              tooltip:{ callbacks:{ label:(ctx)=> {
                const value = ctx.parsed.y !== undefined ? ctx.parsed.y : ctx.raw;
                return ctx.dataset.label+': '+(Math.round(value)).toLocaleString('sv-SE')+' kr';
              } } } }
          }
        });
      } else {
        chart.data.labels = series.labels;
        chart.data.datasets.forEach((ds, idx) => {
          ds.data = datasets[idx].data;
        });
        chart.update();
      }
    }

    // Uppdatering
    function update() {
      const inputs = {
        companyValue: Number(companyValue.value||0),
        companyDebt:  Number(companyDebt.value||0),
        ownership:    Number(ownership.value)/100,
        turnover:     Number(turnover.value||0),
        margin:       Number(margin.value)/100,  // rörelsemarginal/vinstmarginal
        corpTaxRate:  Number(corpTax.value)/100,
        amortShare:   Number(amortShare.value)/100,
        reversRate:   Number(rate.value)/100,
        bankInterestRate: Number(bankRateInput.value)/100,
        bankAmortYears: Number(bankYearsInput.value||0),
        firstYearInterestOnly: interestOnly.checked,
        maxYears:     Number(maxYears.value||1)
      };

      // Härleder resultat före skatt från omsättning * marginal
      inputs.profitBeforeTax = inputs.turnover * inputs.margin;
      resultBeforeTaxLbl.textContent = fmtKr(inputs.profitBeforeTax);

      const equity = inputs.companyValue - inputs.companyDebt;
      equityTag.textContent = 'Eget kapital: ' + equity.toLocaleString('sv-SE') + ' kr';
      const mix = {
        revers: Number(reversShare.value||0),
        bank: Number(bankShare.value||0),
        equity: Number(equityShare.value||0)
      };
      const mixSum = mix.revers + mix.bank + mix.equity;
      fundingSumLbl.textContent = mixSum.toFixed(0) + '%';

      // Lås/öppna bolagsvärde & lån
      companyValue.disabled = lockCompanyFields.checked;
      companyDebt.disabled  = lockCompanyFields.checked;

      // Auto-beräkna köpeskilling från eget kapital vid behov
      let purchasePrice = Number(note.value||0);
      if (calcNoteFromEquity.checked) {
        const autoPrice = Math.max(0, equity * inputs.ownership);
        note.value = Math.round(autoPrice);
        purchasePrice = autoPrice;
        note.disabled = true;
      } else {
        note.disabled = false;
        purchasePrice = Number(note.value||0);
      }
      inputs.purchasePrice = purchasePrice;
      purchasePriceTag.textContent = 'Köpeskilling: ' + fmtKr(purchasePrice);

      ownershipLbl.textContent = Math.round(inputs.ownership*100) + '%';
      turnoverLbl.textContent = (Math.round(inputs.turnover)).toLocaleString('sv-SE') + ' kr';
      marginLbl.textContent = (inputs.margin*100).toFixed(1).replace('.', ',') + '%';
      taxLbl.textContent = (inputs.corpTaxRate*100).toFixed(1).replace('.', ',') + '%';
      amortShareLbl.textContent = Math.round(inputs.amortShare*100) + '%';
      rateLbl.textContent = (inputs.reversRate*100).toFixed(1).replace('.', ',') + '%';
      bankRateLbl.textContent = (inputs.bankInterestRate*100).toFixed(1).replace('.', ',') + '%';
      const bankYearsRounded = Math.round(inputs.bankAmortYears);
      bankYearsLbl.textContent = bankYearsRounded === 0 ? 'Amorteringsfritt' : bankYearsRounded + (bankYearsRounded === 1 ? ' år' : ' år');
      yearsLbl.textContent = inputs.maxYears;

      reversShareLbl.textContent = mix.revers + '%';
      bankShareLbl.textContent   = mix.bank + '%';
      equityShareLbl.textContent = mix.equity + '%';

      const reversPrincipal = purchasePrice * (mix.revers/100);
      const bankPrincipal   = purchasePrice * (mix.bank/100);
      const equityContribution = purchasePrice * (mix.equity/100);
      inputs.reversPrincipal = reversPrincipal;
      inputs.bankPrincipal   = bankPrincipal;
      inputs.equityContribution = equityContribution;

      reversAmountLbl.textContent = fmtKr(reversPrincipal);
      bankAmountLbl.textContent   = fmtKr(bankPrincipal);
      equityAmountLbl.textContent = fmtKr(equityContribution);
      reversAmountSummary.textContent = fmtKr(reversPrincipal);
      bankAmountSummary.textContent   = fmtKr(bankPrincipal);
      equityAmountSummary.textContent = fmtKr(equityContribution);
      purchasePriceSummary.textContent= fmtKr(purchasePrice);

      const schedule = simulate(inputs);
      const data = schedule.years;
      bankPaymentSummary.textContent = schedule.bankPayment ? fmtKr(schedule.bankPayment) : '—';

      const ownerDiv = inputs.profitBeforeTax*(1-inputs.corpTaxRate)*inputs.ownership;
      const companyProfitAfterTax = inputs.profitBeforeTax * (1 - inputs.corpTaxRate);
      ownerSharePBT.textContent = fmtKr(inputs.profitBeforeTax * inputs.ownership);
      resultAfterTaxLbl.textContent = fmtKr(companyProfitAfterTax);
      divPerYear.textContent = fmtKr(ownerDiv);
      y1Amort.textContent = data[0] ? fmtKr(data[0].reversPrincipalPayment) : '—';
      y1BankAmort.textContent = data[0] ? fmtKr(data[0].bankPrincipalPayment) : '—';
      y1Cash.textContent  = data[0] ? fmtKr(data[0].cashPayout)       : '—';
      const reversPaidRow = data.find(r => r.reversRemaining === 0);
      const bankPaidRow   = data.find(r => r.bankRemaining === 0);
      reversYearsToZero.textContent = (inputs.reversPrincipal <= 1) ? '0'
        : (reversPaidRow ? reversPaidRow.year : '>' + inputs.maxYears);
      bankYearsToZero.textContent = (inputs.bankPrincipal <= 1) ? '0'
        : (bankPaidRow ? bankPaidRow.year : '>' + inputs.maxYears);

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      data.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="text-align:left">${r.year}</td>
                        <td>${fmtKr(r.ownerDividend)}</td>
                        <td>${fmtKr(r.reversPrincipalPayment)}</td>
                        <td>${fmtKr(r.bankPrincipalPayment)}</td>
                        <td>${fmtKr(r.reversInterest)}</td>
                        <td>${fmtKr(r.bankInterest)}</td>
                        <td>${fmtKr(r.cashPayout)}</td>
                        <td>${fmtKr(r.reversRemaining)}</td>
                        <td>${fmtKr(r.bankRemaining)}</td>`;
        tbody.appendChild(tr);
      });

      const labels = data.map(r=> 'År ' + r.year);
      buildChart({
        labels,
        reversAmort: data.map(r=> Math.round(r.reversPrincipalPayment)),
        bankAmort:   data.map(r=> Math.round(r.bankPrincipalPayment)),
        reversInterest: data.map(r=> Math.round(r.reversInterest)),
        bankInterest: data.map(r=> Math.round(r.bankInterest)),
        cash: data.map(r=> Math.round(r.cashPayout)),
        totalDividend: data.map(r=> Math.round(r.ownerDividend)),
        reversRemaining: data.map(r=> Math.round(r.reversRemaining)),
        bankRemaining: data.map(r=> Math.round(r.bankRemaining))
      });
    }

    if (loginForm) {
      loginForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const password = (loginPassword.value || '').trim();
        if (!password) {
          if (loginPassword) loginPassword.focus();
          return;
        }
        try {
          const hash = await hashPassword(password);
          if (profileConfigs[hash]) {
            showCalculator(hash);
          } else if (loginError) {
            loginError.textContent = 'Fel lösenord, försök igen.';
            loginError.classList.remove('hidden');
            if (loginPassword) {
              loginPassword.select();
            }
          }
        } catch (err) {
          if (loginError) {
            loginError.textContent = 'Din webbläsare stödjer tyvärr inte inloggningen.';
            loginError.classList.remove('hidden');
          }
          console.error(err);
        }
      });
    }

    if (loginPassword) {
      loginPassword.addEventListener('input', () => {
        if (loginError) {
          loginError.textContent = 'Fel lösenord, försök igen.';
          loginError.classList.add('hidden');
        }
      });
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        showLogin(true);
      });
    }

    [companyValue, companyDebt, ownership, turnover, margin, corpTax, note, amortShare, rate, bankRateInput, bankYearsInput, interestOnly, maxYears].forEach(el => {
      el.addEventListener('input', update);
      el.addEventListener('change', update);
    });

    bindShareHandlers();
    rebalanceShares('revers', Number(reversShare.value||0));

    [calcNoteFromEquity, lockCompanyFields].forEach(el => {
      el.addEventListener('input', update);
      el.addEventListener('change', update);
    });

    reset.addEventListener('click', () => {
      companyValue.value = 8000000; companyDebt.value = 500000; ownership.value = 16;
      turnover.value = 13453000; margin.value = 19.4; corpTax.value = 20.6; note.value = 1200000; amortShare.value = 50;
      rate.value = 2; bankRateInput.value = 5; bankYearsInput.value = 5;
      reversShare.value = 60; bankShare.value = 30; equityShare.value = 10;
      interestOnly.checked = true; maxYears.value = 15;
      calcNoteFromEquity.checked = true; // default: beräkna från eget kapital
      lockCompanyFields.checked  = true; // default: låsta
      rebalanceShares('revers', Number(reversShare.value||0));
      update();
    });

    const savedHash = localStorage.getItem(PROFILE_STORAGE_KEY);
    if (savedHash && profileConfigs[savedHash]) {
      showCalculator(savedHash);
    } else {
      if (sessionControls) {
        sessionControls.classList.remove('active');
      }
      if (activeProfile) {
        activeProfile.textContent = '';
        activeProfile.classList.add('hidden');
      }
      if (loginScreen) {
        showWithFade(loginScreen);
      }
      if (loginPassword) {
        setTimeout(() => loginPassword.focus(), 300);
      }
    }

    update();
  </script>
</body>
</html>
